<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tester API BM - Completo (Local)</title>
    <style>
        :root { --primary: #3b82f6; --bg: #f1f5f9; --card: #ffffff; --text: #1e293b; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 1100px; margin: 0 auto; }
        
        /* Layout */
        .grid-main { display: grid; grid-template-columns: 350px 1fr; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Inputs & Buttons */
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        label { font-weight: 600; font-size: 0.85em; color: #64748b; margin-bottom: 5px; display: block; margin-top: 10px; }
        
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button.secondary { background: #94a3b8; }
        button.danger { background: var(--danger); }
        
        /* Response Area */
        #url-preview { background: #334155; color: #fff; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 0.9em; word-break: break-all; margin-bottom: 10px; }
        #response-area { background: #0f172a; color: #10b981; padding: 15px; border-radius: 6px; font-family: 'Consolas', monospace; white-space: pre-wrap; height: 500px; overflow: auto; font-size: 0.9em; }
        
        /* Utilities */
        .hidden { display: none; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }
        .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: bold; }
        
        /* Auth Status */
        .auth-status { padding: 10px; border-radius: 6px; margin-top: 10px; font-size: 0.9em; }
        .logged-in { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .logged-out { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    </style>
</head>
<body>

    <h1>üçî Burguer Marina API Tester <small style="font-size:0.5em; color:#64748b">v3.1 (Rutas Planas)</small></h1>

    <div class="grid-main">
        
        <div class="left-col">
            
            <div class="card">
                <h3>üîê Autenticaci√≥n</h3>
                <div id="login-form">
                    <label>Email</label>
                    <input type="email" id="email" value="admin@test.com">
                    <label>Password</label>
                    <input type="password" id="password" value="1234">
                    <button onclick="login()">Iniciar Sesi√≥n</button>
                </div>

                <div id="user-info" class="hidden">
                    <div class="auth-status logged-in">
                        üë§ <b><span id="user-role-display"></span></b><br>
                        <small id="user-email-display"></small>
                    </div>
                    <label>Token (JWT)</label>
                    <textarea id="jwt-token" rows="2" readonly style="font-size: 0.7em; background:#f8fafc"></textarea>
                    <button class="secondary" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>

            <div class="card">
                <h3>‚öôÔ∏è Petici√≥n</h3>
                
                <label>M√©todo</label>
                <select id="method" onchange="updateUI()">
                    <option value="GET">GET (Listar / Ver)</option>
                    <option value="POST">POST (Crear)</option>
                    <option value="PUT">PUT (Editar - Admin)</option>
                    <option value="DELETE">DELETE (Borrar - Admin)</option>
                </select>

                <label>Ruta Archivo API</label>
                <input type="text" id="base-url" value="platos.php" oninput="buildUrl()">

                <label style="margin-top:15px">Acciones R√°pidas</label>
                <div class="row" style="gap:5px">
                    <button class="secondary" style="width:auto; flex:1; padding:8px; margin:0; font-size:0.8em" onclick="quickAction('list')">Listar</button>
                    <button class="secondary" style="width:auto; flex:1; padding:8px; margin:0; font-size:0.8em" onclick="quickAction('count')">Conteo</button>
                </div>

                <div id="id-group">
                    <label>ID del Plato <small>(Opcional en GET)</small></label>
                    <input type="number" id="resource-id" placeholder="Ej: 1" oninput="buildUrl()">
                    
                    <div id="detallado-group" class="hidden" style="margin-top:5px">
                         <input type="checkbox" id="detallado-check" onchange="buildUrl()" style="width:auto"> 
                         <label style="display:inline">Ver Detallado</label>
                    </div>
                </div>

                <div id="get-filters" class="">
                    <hr style="border:0; border-top:1px solid #e2e8f0; margin: 15px 0;">
                    <strong style="color:#64748b; font-size:0.9em">Filtros de Listado</strong>
                    
                    <label>Buscar (?search)</label>
                    <input type="text" id="search" placeholder="Hamburguesa..." oninput="buildUrl()">
                    
                    <div class="row">
                        <div class="col">
                            <label>P√°gina</label>
                            <input type="number" id="page" value="1" min="1" oninput="buildUrl()">
                        </div>
                        <div class="col">
                            <label>L√≠mite</label>
                            <input type="number" id="limit" value="5" min="1" oninput="buildUrl()">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <label>Ordenar por</label>
                            <select id="order" onchange="buildUrl()">
                                <option value="id_plato">ID</option>
                                <option value="nombre">Nombre</option>
                                <option value="precio">Precio</option>
                            </select>
                        </div>
                        <div class="col">
                            <label>Direcci√≥n</label>
                            <select id="dir" onchange="buildUrl()">
                                <option value="ASC">ASC</option>
                                <option value="DESC">DESC</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="body-section" class="hidden">
                    <hr style="border:0; border-top:1px solid #e2e8f0; margin: 15px 0;">
                    <div class="row" style="align-items:center; justify-content:space-between">
                        <label style="margin:0">JSON Body</label>
                        <button class="secondary" style="width:auto; padding:2px 8px; margin:0; font-size:0.7em" onclick="fillTemplate()">Rellenar Plantilla</button>
                    </div>
                    <textarea id="json-body" rows="8"></textarea>
                </div>

                <button onclick="sendRequest()" id="send-btn" style="margin-top:20px; font-size: 1.1em">üöÄ Enviar Petici√≥n</button>
            </div>
        </div>

        <div class="right-col">
            <div class="card" style="height: calc(100% - 40px);">
                <h3>üì° Respuesta del Servidor</h3>
                <div id="url-preview">GET platos.php?page=1...</div>
                <div class="row" style="margin-bottom:10px; align-items:center">
                    <span id="status-badge" class="badge" style="background:#eee; color:#666; font-size:1em">Status: -</span>
                    <span id="time-badge" style="margin-left:auto; font-size:0.8em; color:#999">0 ms</span>
                </div>
                <div id="response-area">Esperando petici√≥n...</div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. L√ìGICA DE AUTH ---
        function checkAuth() {
            const token = localStorage.getItem('bm_token');
            if (token) {
                const user = localStorage.getItem('bm_user');
                const role = localStorage.getItem('bm_role');
                
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-email-display').innerText = user || 'Usuario';
                document.getElementById('user-role-display').innerText = role ? role.toUpperCase() : 'USER';
                document.getElementById('jwt-token').value = token;
            } else {
                document.getElementById('login-form').classList.remove('hidden');
                document.getElementById('user-info').classList.add('hidden');
            }
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                // CORREGIDO: Ruta directa 'login.php' (sin api/)
                const res = await fetch('login.php', { 
                    method: 'POST', 
                    body: JSON.stringify({ email, password }),
                    headers: {'Content-Type': 'application/json'}
                });
                
                let data;
                try { data = await res.json(); } catch { data = { error: "Respuesta no es JSON" }; }
                
                if (res.ok) {
                    localStorage.setItem('bm_token', data.token);
                    localStorage.setItem('bm_user', data.usuario.email);
                    localStorage.setItem('bm_role', data.usuario.rol);
                    checkAuth();
                } else {
                    alert('Error Login: ' + (data.error || res.statusText));
                }
            } catch (e) {
                console.error(e);
                alert('Error de conexi√≥n con login.php. ¬øEst√° el archivo en la misma carpeta?');
            }
        }

        function logout() {
            localStorage.clear();
            checkAuth();
        }

        // --- 2. L√ìGICA DE UI Y URL ---
        function updateUI() {
            const method = document.getElementById('method').value;
            const idValue = document.getElementById('resource-id').value;
            
            const isGet = method === 'GET';
            const hasId = idValue.length > 0;
            const needsBody = (method === 'POST' || method === 'PUT');

            const showFilters = isGet && !hasId;
            document.getElementById('get-filters').classList.toggle('hidden', !showFilters);
            
            const showDetallado = isGet && hasId;
            document.getElementById('detallado-group').classList.toggle('hidden', !showDetallado);

            document.getElementById('body-section').classList.toggle('hidden', !needsBody);
            
            const btn = document.getElementById('send-btn');
            btn.className = '';
            if (method === 'DELETE') btn.classList.add('danger');
            
            buildUrl();
        }

        function fillTemplate() {
            const template = {
                "nombre": "Hamburguesa Tester " + Math.floor(Math.random()*100),
                "descripcion": "Descripci√≥n generada para pruebas.",
                "precio": (Math.random() * 15 + 5).toFixed(2),
                "imagen": "default.jpg",
                "id_categoria": 1
            };
            document.getElementById('json-body').value = JSON.stringify(template, null, 4);
        }

        function quickAction(action) {
            if (action === 'list') {
                document.getElementById('method').value = 'GET';
                document.getElementById('base-url').value = 'platos.php';
                document.getElementById('resource-id').value = '';
                updateUI();
                setTimeout(() => sendRequest(), 100);
            } else if (action === 'count') {
                document.getElementById('method').value = 'GET';
                document.getElementById('base-url').value = 'platos.php';
                document.getElementById('resource-id').value = '';
                updateUI();
                setTimeout(() => {
                    document.getElementById('url-preview').innerText = 'GET platos.php?count=1';
                    sendRequest();
                }, 100);
            }
        }

        function buildUrl() {
            const base = document.getElementById('base-url').value;
            const method = document.getElementById('method').value;
            const id = document.getElementById('resource-id').value;
            
            let url = base;
            let params = [];

            if (id) {
                params.push(`id=${id}`);
                if (method === 'GET' && document.getElementById('detallado-check').checked) {
                    params.push('detallado=1');
                }
            } 
            else if (method === 'GET') {
                const page = document.getElementById('page').value;
                const limit = document.getElementById('limit').value;
                const search = document.getElementById('search').value;
                const order = document.getElementById('order').value;
                const dir = document.getElementById('dir').value;

                if(page) params.push(`page=${page}`);
                if(limit) params.push(`limit=${limit}`);
                if(search) params.push(`search=${encodeURIComponent(search)}`);
                if(order) params.push(`order=${order}`);
                if(dir) params.push(`dir=${dir}`);
            }

            if (params.length > 0) {
                url += '?' + params.join('&');
            }

            document.getElementById('url-preview').innerText = method + ' ' + url;
            
            // Refresco de visibilidad de filtros al escribir ID
            const isGet = method === 'GET';
            document.getElementById('get-filters').classList.toggle('hidden', !(isGet && !id));
            document.getElementById('detallado-group').classList.toggle('hidden', !(isGet && id));
            
            return url;
        }

        // --- 3. ENVIAR PETICI√ìN ---
        async function sendRequest() {
            const method = document.getElementById('method').value;
            // Quitamos el verbo HTTP del preview para obtener solo la URL
            const urlFull = document.getElementById('url-preview').innerText.replace(method + ' ', ''); 
            const token = localStorage.getItem('bm_token');
            const jsonBody = document.getElementById('json-body').value;
            const responseArea = document.getElementById('response-area');
            const statusBadge = document.getElementById('status-badge');

            responseArea.innerText = "‚è≥ Cargando...";
            statusBadge.innerText = "Status: ...";
            statusBadge.style.background = "#eee";

            const options = {
                method: method,
                headers: { 'Content-Type': 'application/json' }
            };

            if (token) options.headers['Authorization'] = `Bearer ${token}`;

            if ((method === 'POST' || method === 'PUT') && jsonBody) {
                try {
                    JSON.parse(jsonBody);
                    options.body = jsonBody;
                } catch (e) {
                    alert("El JSON no es v√°lido");
                    return;
                }
            }

            const startTime = performance.now();

            try {
                const res = await fetch(urlFull, options);
                const endTime = performance.now();
                
                document.getElementById('time-badge').innerText = Math.round(endTime - startTime) + ' ms';

                const status = res.status;
                statusBadge.innerText = `Status: ${status} ${res.statusText}`;
                
                if (status >= 200 && status < 300) {
                    statusBadge.style.background = "#dcfce7"; statusBadge.style.color = "#166534";
                    responseArea.style.color = "#10b981"; 
                } else if (status >= 400 && status < 500) {
                    statusBadge.style.background = "#ffedd5"; statusBadge.style.color = "#9a3412";
                    responseArea.style.color = "#fbbf24";
                } else {
                    statusBadge.style.background = "#fee2e2"; statusBadge.style.color = "#991b1b";
                    responseArea.style.color = "#ef4444";
                }

                try {
                    const data = await res.json();
                    responseArea.innerText = JSON.stringify(data, null, 4);
                } catch (err) {
                    const text = await res.text();
                    responseArea.innerText = text || "(Respuesta vac√≠a)";
                }

            } catch (err) {
                responseArea.innerText = "‚ùå Error de Red: " + err + "\n\n(Aseg√∫rate de que 'platos.php' existe en la misma carpeta que este HTML)";
                responseArea.style.color = "#ef4444";
            }
        }

        window.onload = () => {
            checkAuth();
            buildUrl();
        };
    </script>
</body>
</html>